name: Deploy VerveStacks Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  # Flags
  Update_Data_On_Local: "true"
  Update_Data_On_Hetzner: "false"

  # Deployment roots
  DEPLOY_ROOT: "C:\\inetpub\\VerveStacks"
  DATA_ROOT: "C:\\inetpub\\VerveStacks\\data"

  # Local data source root (your main local data source)
  LOCAL_DATA_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\data"

  # Base UNC share (YAML-escaped; runtime value is \\192.168.0.7\kanvault)
  KANVAULT_SHARE: "\\\\192.168.0.7\\kanvault"

  # Destination data paths
  DEST_OSM: "C:\\inetpub\\VerveStacks\\data\\OSM-kan-prebuilt"
  DEST_TRANSMISSION: "C:\\inetpub\\VerveStacks\\data\\transmission_line_generation"
  DEST_ATLITE: "C:\\inetpub\\VerveStacks\\data\\Atlite_data_optimized"
  DEST_REZONING: "C:\\inetpub\\VerveStacks\\data\\REZoning_world_data"

  # Application subroot (beneath DEPLOY_ROOT)
  APP_SUBROOT: "vervestacks-dashboard"

  # Python service settings
  PYTHON_EXE: "C:\\Python312\\python.exe"

  # App source root (kept for reference)
  APP_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\vervestacks-dashboard"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # =====================
      # CHECKOUT REPOSITORY
      # =====================
      - name: Checkout code
        uses: actions/checkout@v4

      # =====================
      # INIT WORKFLOW RUN LOG
      # =====================
      - name: Init workflow run log file
        shell: powershell
        run: |
          $stepName = 'Init workflow run log file'
          $logRoot = 'D:\GitHub\VerveStacks_Logs'
          $ErrorActionPreference = 'Stop'
          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace
            exit 1
          }

          if (-not (Test-Path $logRoot)) {
            New-Item -ItemType Directory -Path $logRoot | Out-Null
          }

          $timestamp = Get-Date -Format 'yyyy-MM-ddTHH-mm-ss'
          $fileName  = "${{ github.workflow }}_${{ github.run_number }}_${{ github.job }}_$timestamp.log"
          $safeName  = ($fileName -replace '[\\/:*?"<>|]', '_')
          $logFile   = Join-Path $logRoot $safeName

          "STEP     : $stepName"                | Out-File -FilePath $logFile -Encoding UTF8
          "Workflow : $env:GITHUB_WORKFLOW"     | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Run ID   : $env:GITHUB_RUN_ID"       | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Job      : $env:GITHUB_JOB"          | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Repo     : $env:GITHUB_REPOSITORY"   | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Commit   : $env:GITHUB_SHA"          | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Actor    : $env:GITHUB_ACTOR"        | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Workspace: $env:GITHUB_WORKSPACE"    | Out-File -FilePath $logFile -Encoding UTF8 -Append
          "Started  : $(Get-Date -Format o)"    | Out-File -FilePath $logFile -Encoding UTF8 -Append
          '--------------------------------------' | Out-File -FilePath $logFile -Encoding UTF8 -Append

          "LOG_FILE=$logFile" | Out-File -FilePath $env:GITHUB_ENV -Encoding UTF8 -Append
          exit 0

      # =====================
      # MAP UNC SHARE (kanvault)
      # =====================
      - name: Map kanvault share
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        env:
          KANVAULT_PASSWORD: ${{ secrets.KANVAULT_PASSWORD }}
        run: |
          $stepName = 'Map kanvault share'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'
          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace

            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="
          Write-Host "Mapping $env:KANVAULT_SHARE with user 'amit'"

          try {
            Write-Host "Attempting to delete existing mapping..."
            net use $env:KANVAULT_SHARE /delete /y
          } catch {
            Write-Host "No existing mapping or delete failed. Continuing."
          }

          net use $env:KANVAULT_SHARE /user:amit $env:KANVAULT_PASSWORD
          if ($LASTEXITCODE -ne 0) {
            Write-Host "### ERROR DETAIL: net use failed with exit code $LASTEXITCODE."
            if ($log) { Stop-Transcript | Out-Null }
            exit $LASTEXITCODE
          }

          Write-Host "UNC network share mapped successfully."

          if ($log) { Stop-Transcript | Out-Null }
          exit 0

      # ==========================================================
      # 1) ALL DATA SYNC (KANVAULT + LOCAL) IN ONE STEP
      # ==========================================================
      - name: Sync all data (kanvault + local) to IIS
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          $stepName = 'Sync all data (kanvault + local) to IIS'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'

          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace
            
            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="

          $shareRoot = $env:KANVAULT_SHARE
          $verveRoot = Join-Path $shareRoot 'KanORS_Data\VerveStacks'
          $rezRoot   = Join-Path $shareRoot 'KanORS_Data\REZoning data'

          Write-Host "VerveStacks UNC root = $verveRoot"
          Write-Host "REZoning UNC root    = $rezRoot"

          $syncJobs = @(
            @{ Name = 'OSM-kan-prebuilt'
               Source = Join-Path $verveRoot 'OSM-kan-prebuilt'
               Dest   = $env:DEST_OSM },
            @{ Name = 'OSM-kan-prebuilt (harish)'
               Source = Join-Path $verveRoot 'OSM-kan-prebuilt\harish'
               Dest   = $env:DEST_OSM },
            @{ Name = 'transmission_line_generation'
               Source = Join-Path $verveRoot 'transmission_line_generation'
               Dest   = $env:DEST_TRANSMISSION },
            @{ Name = 'Atlite_data_optimized'
               Source = Join-Path $rezRoot 'Atlite_data\Atlite_data_optimized'
               Dest   = $env:DEST_ATLITE },
            @{ Name = 'REZoning_world_data'
               Source = Join-Path $rezRoot 'REZoning_world_data'
               Dest   = $env:DEST_REZONING }
          )

          $exitCodes = @()

          foreach ($job in $syncJobs) {
            $name   = $job.Name
            $source = $job.Source
            $dest   = $job.Dest

            Write-Host "----"
            Write-Host "Job: $name"
            Write-Host "  Source: $source"
            Write-Host "  Dest  : $dest"

            if (-not (Test-Path $dest)) {
              Write-Host "Creating destination folder: $dest"
              New-Item -ItemType Directory -Path $dest | Out-Null
            }

            if (-not (Test-Path $source)) {
              Write-Host "WARNING: Source does not exist: $source"
              continue
            }

            Write-Host "Starting robocopy for '$name'..."
            robocopy $source $dest /E /Z /R:3 /W:5 /ETA /NP
            $exitCodes += $LASTEXITCODE

            Write-Host "Robocopy exit code: $LASTEXITCODE"
          }

          $maxCode = ($exitCodes | Measure-Object -Maximum).Maximum

          Write-Host "Max robocopy code = $maxCode"
          Write-Host "INFO: 0â€“7 success, 8+ failure"

          if ($maxCode -ge 8) {
            Write-Host "### ERROR DETAIL: One or more sync jobs failed."
            if ($log) { Stop-Transcript | Out-Null }
            exit $maxCode
          }

          Write-Host "All data sync jobs completed successfully."

          if ($log) { Stop-Transcript | Out-Null }
          exit 0

      # ==========================================================
      # ðŸš« REMOVED APP DEPLOY STEP â€” AS YOU REQUESTED
      # ==========================================================

      # ==========================================================
      # 3) BACKEND + FRONTEND (npm)
      # ==========================================================
      - name: Install JS deps and build frontend on DEPLOY_ROOT
        shell: powershell
        run: |
          $stepName = 'Install JS deps and build frontend'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'

          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace
            
            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="

          $appRoot   = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $backend   = Join-Path $appRoot 'backend'
          $frontend  = Join-Path $appRoot 'frontend'

          $apps = @(
            @{ Name = 'Backend'; Path = $backend; Build = $false },
            @{ Name = 'Frontend'; Path = $frontend; Build = $true }
          )

          foreach ($a in $apps) {
            $name  = $a.Name
            $path  = $a.Path
            $build = $a.Build

            Write-Host "----"
            Write-Host "$name: Path = $path"

            if (-not (Test-Path $path)) {
              Write-Host "ERROR: $name path does not exist: $path"
              exit 1
            }

            cd $path

            Write-Host "$name: running npm install..."
            npm install
            if ($LASTEXITCODE -ne 0) {
              Write-Host "$name: npm install failed"
              exit 1
            }

            if ($build) {
              Write-Host "$name: running build:prod..."
              $env:CI = "false"
              npm run build:prod
              if ($LASTEXITCODE -ne 0) {
                Write-Host "$name: React build failed"
                exit 1
              }
            }
          }

          if ($log) { Stop-Transcript | Out-Null }
          exit 0

      # ==========================================================
      # 3b) Publish frontend build to IIS root
      # ==========================================================
      - name: Publish frontend build to IIS root
        shell: powershell
        run: |
          $stepName = 'Publish frontend build to IIS root'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'

          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace
            
            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="

          $appRoot  = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $buildDir = Join-Path $appRoot 'frontend\build'

          Write-Host "App root  = $appRoot"
          Write-Host "Build dir = $buildDir"

          if (-not (Test-Path $buildDir)) {
            Write-Host "### ERROR DETAIL: React build folder not found."
            exit 1
          }

          robocopy $buildDir $appRoot /E /R:3 /W:5 /NFL /NDL /NJH /NJS /NP
          $code = $LASTEXITCODE

          Write-Host "Robocopy exit code: $code"

          if ($code -ge 8) {
            Write-Host "### ERROR: Publishing build failed."
            exit $code
          }

          Write-Host "Frontend build published successfully."

          if ($log) { Stop-Transcript | Out-Null }
          exit 0

      # ==========================================================
      # 4) PYTHON SERVICE SETUP
      # ==========================================================
      - name: Setup python service on deployed folder
        shell: powershell
        run: |
          $stepName = 'Setup python service'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'

          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace
            
            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="

          $appRoot    = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $pythonPath = Join-Path $appRoot 'python-service'

          Write-Host "Python service path = $pythonPath"
          Write-Host "PYTHON_EXE         = $env:PYTHON_EXE"

          if (-not (Test-Path $pythonPath)) {
            Write-Host "ERROR: python-service folder not found"
            exit 1
          }

          cd $pythonPath

          if (-not (Test-Path '.venv')) {
            Write-Host "Creating virtual environment..."
            & $env:PYTHON_EXE -m venv .venv
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

          if ($log) { Stop-Transcript | Out-Null }
          exit 0

      # ==========================================================
      # 5) PLACEHOLDER: HETZNER DEPLOY
      # ==========================================================
      - name: Deploy to Hetzner (placeholder)
        if: env.Update_Data_On_Hetzner == 'true'
        shell: powershell
        run: |
          Write-Host "Hetzner deploy not implemented."
          exit 0

      # ==========================================================
      # 6) RUN start.bat AFTER DEPLOYMENT
      # ==========================================================
      - name: Run start.bat after deployment
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          $stepName = 'Run start.bat'
          $log = $env:LOG_FILE

          if ($log) { Start-Transcript -Path $log -Append | Out-Null }

          $ErrorActionPreference = 'Stop'

          trap {
            Write-Host "### STEP FAILED: $stepName"
            Write-Host "### ERROR: $($_.Exception.Message)"
            Write-Host $_.ScriptStackTrace

            if ($log) { Stop-Transcript | Out-Null }
            exit 1
          }

          Write-Host "=== [$stepName] ==="

          $scriptPath = Join-Path $env:DEPLOY_ROOT "$env:APP_SUBROOT\start.bat"

          Write-Host "start.bat path: $scriptPath"

          if (-not (Test-Path $scriptPath)) {
            Write-Host "ERROR: start.bat not found"
            exit 1
          }

          & $scriptPath
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: start.bat failed."
            exit $LASTEXITCODE
          }

          Write-Host "start.bat completed successfully."

          if ($log) { Stop-Transcript | Out-Null }
          exit 0