name: Deploy VerveStacks Dashboard

on:
  push:
    branches: [ "main" ]

env:
  # Deployment Flags
  Update_Data_On_Local: "true"
  Update_Data_On_Hetzner: "false"

  # Local Paths

  # Source UNC paths

  # Destination Paths
  DEPLOY_ROOT: 'C:\inetpub\VerveStacks\vervestacks-dashboard'
  DATA_ROOT: 'C:\inetpub\VerveStacks\data'

  # Source UNC paths
  SOURCE_OSM_HARISH: '\\192.168.0.7\kanvault\KanORS_Data\VerveStacks\OSM-kan-prebuilt\harish'
  SOURCE_TRANSMISSION: '\\192.168.0.7\kanvault\KanORS_Data\VerveStacks\transmission_line_generation'
  SOURCE_ATLITE: '\\192.168.0.7\kanvault\KanORS_Data\REZoning data\Atlite_data\Atlite_data_optimized'
  SOURCE_REZONING_WORLD: '\\192.168.0.7\kanvault\KanORS_Data\REZoning data\REZoning_world_data'

  # Destination Paths
  DEST_OSM: 'C:\inetpub\VerveStacks\data\OSM-kan-prebuilt'
  DEST_TRANSMISSION: 'C:\inetpub\VerveStacks\data\transmission_line_generation'
  DEST_ATLITE: 'C:\inetpub\VerveStacks\data\hourly_profiles\Atlite_data'
  DEST_REZONING: 'C:\inetpub\VerveStacks\data\REZoning'

  # Code folders
  BACKEND_DIR: vervestacks-dashboard/backend
  FRONTEND_DIR: vervestacks-dashboard/frontend
  PYTHON_DIR: vervestacks-dashboard/python-service

  # Python executable
  PYTHON_EXE: "D:\\Pyvenvs\\Scripts\\python.exe"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # =========================================
    # MAP UNC SHARE WITH CREDENTIALS
    # =========================================
    - name: Map kanvault drive
      if: env.Update_Data_On_Local == 'true'
      shell: powershell
      env:
        KANVAULT_PASSWORD: ${{ secrets.KANVAULT_PASSWORD }}
      run: |
        Write-Host "=== Mapping \\192.168.0.7\kanvault ==="

        try {
          net use \\192.168.0.7\kanvault /delete /y 2>$null | Out-Null
        } catch {
          Write-Host "No existing mapping found. Continuing..."
        }
        $global:LASTEXITCODE = 0

        net use \\192.168.0.7\kanvault /user:amit $env:KANVAULT_PASSWORD

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to map UNC share"
          exit $LASTEXITCODE
        }

        Write-Host "UNC network share mapped successfully."

    # =========================================
    # SYNC KANVAULT DATA TO LOCAL DESTINATIONS
    # =========================================
    - name: Sync kanvault data → local data folders
      if: env.Update_Data_On_Local == 'true'
      shell: powershell
      run: |
        Write-Host "=== Syncing kanvault data to local data folders ==="

        $destRoots = @(
          $env:DEST_OSM,
          $env:DEST_TRANSMISSION,
          $env:DEST_ATLITE,
          $env:DEST_REZONING
        )

        foreach ($d in $destRoots) {
          if (-not (Test-Path $d)) {
            Write-Host "Creating folder: $d"
            [System.IO.Directory]::CreateDirectory($d) | Out-Null
          }
        }

        Write-Host "Syncing OSM-kan-prebuilt/harish → DEST_OSM"
        robocopy $env:SOURCE_OSM_HARISH $env:DEST_OSM /MIR /NFL /NDL /NJH /NJS /NP

        Write-Host "Syncing transmission_line_generation → DEST_TRANSMISSION"
        robocopy $env:SOURCE_TRANSMISSION $env:DEST_TRANSMISSION /MIR /NFL /NDL /NJH /NJS /NP

        Write-Host "Syncing Atlite_data_optimized → DEST_ATLITE"
        robocopy $env:SOURCE_ATLITE $env:DEST_ATLITE /MIR /NFL /NDL /NJH /NJS /NP

        Write-Host "Syncing REZoning_world_data → DEST_REZONING"
        robocopy $env:SOURCE_REZONING_WORLD $env:DEST_REZONING /MIR /NFL /NDL /NJH /NJS /NP

    # =========================================
    # RUN START.BAT BEFORE DEPLOYMENT
    # =========================================
    - name: Run start.bat before deployment
      shell: powershell
      run: |
        Write-Host "=== Running start.bat BEFORE deployment ==="
        & "D:\GitHub\VerveStacks\vervestacks-dashboard\start.bat"

    # =========================================
    # FRONTEND BUILD (CI=FALSE)
    # =========================================
    - name: Install frontend dependencies
      shell: powershell
      run: |
        cd $env:FRONTEND_DIR
        npm install

    - name: Build frontend (ignore ESLint warnings)
      shell: powershell
      run: |
        cd $env:FRONTEND_DIR
        set CI=false
        npm run build:prod

    - name: Deploy frontend build
      shell: powershell
      run: |
        $src = Join-Path $env:FRONTEND_DIR "build"
        $dst = Join-Path $env:DEPLOY_ROOT "frontend\build"

        if (-not (Test-Path $dst)) {
          New-Item -ItemType Directory -Path $dst -Force | Out-Null
        }

        robocopy $src $dst /MIR /NFL /NDL /NJH /NJS /NP

    # =========================================
    # BACKEND DEPLOY
    # =========================================
    - name: Deploy backend
      shell: powershell
      run: |
        $src = $env:BACKEND_DIR
        $dst = Join-Path $env:DEPLOY_ROOT "backend"

        if (-not (Test-Path $dst)) {
          New-Item -ItemType Directory -Path $dst -Force | Out-Null
        }

        robocopy $src $dst /MIR /NFL /NDL /NJH /NJS /NP

    # =========================================
    # PYTHON SERVICE DEPLOY
    # =========================================
    - name: Deploy python service
      shell: powershell
      run: |
        $src = $env:PYTHON_DIR
        $dst = Join-Path $env:DEPLOY_ROOT "python-service"

        if (-not (Test-Path $dst)) {
          New-Item -ItemType Directory -Path $dst -Force | Out-Null
        }

        robocopy $src $dst /MIR /NFL /NDL /NJH /NJS /NP
