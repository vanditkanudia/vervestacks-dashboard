name: Deploy VerveStacks Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  DEPLOY_ROOT: "C:\\inetpub\\VerveStacks"
  APP_SUBROOT: "vervestacks-dashboard"

  APP_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\vervestacks-dashboard"

  KANVAULT_SHARE: "\\\\192.168.0.7\\kanvault"
  LOCAL_DATA_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\data"

  DEST_OSM: "C:\\inetpub\\VerveStacks\\data\\OSM-kan-prebuilt"
  DEST_TRANSMISSION: "C:\\inetpub\\VerveStacks\\data\\transmission_line_generation"
  DEST_ATLITE: "C:\\inetpub\\VerveStacks\\data\\Atlite_data_optimized"
  DEST_REZONING: "C:\\inetpub\\VerveStacks\\data\\REZoning_world_data"

  PYTHON_EXE: "C:\\Python312\\python.exe"
  Update_Data_On_Local: "true"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ===========================
      # INIT LOG FILE
      # ===========================
      - name: Init Deployment Log
        shell: powershell
        run: |
          $folder = "D:\GitHub\VerveStacks_Logs"
          if (-not (Test-Path $folder)) { New-Item -ItemType Directory -Path $folder | Out-Null }

          $ts = Get-Date -Format "yyyy-MM-ddTHH-mm-ss"
          $log = "$folder\deploy_$ts.log"

          "LOG_FILE=$log" | Out-File -FilePath $env:GITHUB_ENV -Encoding UTF8 -Append
          exit 0

      # ===========================
      # MAP KANVAULT SHARE
      # ===========================
      - name: Map kanvault share
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        env:
          KANVAULT_PASSWORD: ${{ secrets.KANVAULT_PASSWORD }}
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          net use $env:KANVAULT_SHARE /delete /y 2>$null
          net use $env:KANVAULT_SHARE /user:amit $env:KANVAULT_PASSWORD

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Share mapping failed!"
            Stop-Transcript | Out-Null
            exit 1
          }

          Stop-Transcript | Out-Null
          exit 0

      # ===========================
      # SYNC DATA TO IIS
      # ===========================
      - name: Sync Data
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null

          $ErrorActionPreference = "Stop"

          $shareRoot = $env:KANVAULT_SHARE
          $verveRoot = Join-Path $shareRoot "KanORS_Data\VerveStacks"
          $rezRoot   = Join-Path $shareRoot "KanORS_Data\REZoning data"

          $jobs = @(
            @{Name="OSM"; Source=Join-Path $verveRoot "OSM-kan-prebuilt"; Dest=$env:DEST_OSM},
            @{Name="OSM Harish"; Source=Join-Path $verveRoot "OSM-kan-prebuilt\harish"; Dest=$env:DEST_OSM},
            @{Name="Transmission"; Source=Join-Path $verveRoot "transmission_line_generation"; Dest=$env:DEST_TRANSMISSION},
            @{Name="Atlite"; Source=Join-Path $rezRoot "Atlite_data\Atlite_data_optimized"; Dest=$env:DEST_ATLITE},
            @{Name="REZoning"; Source=Join-Path $rezRoot "REZoning_world_data"; Dest=$env:DEST_REZONING}
          )

          foreach ($j in $jobs) {
            Write-Host "--- Sync: $($j.Name)"

            if (-not (Test-Path $j.Source)) { Write-Host "Skip (missing source)"; continue }
            if (-not (Test-Path $j.Dest)) { New-Item -ItemType Directory -Path $j.Dest | Out-Null }

            robocopy $j.Source $j.Dest /E /Z /R:3 /W:5 /NP
            if ($LASTEXITCODE -ge 8) {
              Write-Host "Robocopy failed!"
              Stop-Transcript | Out-Null
              exit $LASTEXITCODE
            }
          }

          Stop-Transcript | Out-Null
          exit 0

      # ============================
      # COPY ONLY backend, frontend, python-service (NO WHOLE STRUCTURE)
      # ============================
      - name: Deploy app folders EXACTLY as before
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $srcRoot = $env:APP_SOURCE_ROOT
          $dstRoot = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT

          # Create root folder if missing
          if (-not (Test-Path $dstRoot)) { New-Item -ItemType Directory -Path $dstRoot | Out-Null }

          $folders = @("frontend", "backend", "python-service")

          foreach ($f in $folders) {
            $src = Join-Path $srcRoot $f
            $dst = Join-Path $dstRoot $f

            if (-not (Test-Path $src)) { Write-Host "Skip (missing): $src"; continue }
            if (-not (Test-Path $dst)) { New-Item -ItemType Directory -Path $dst | Out-Null }

            # EXCLUDE .git and .github folders
            robocopy $src $dst /E /Z /R:3 /W:5 /XD ".git" ".github" /NP

            if ($LASTEXITCODE -ge 8) {
              Write-Host "Folder copy failed ($f)"
              Stop-Transcript | Out-Null
              exit $LASTEXITCODE
            }
          }

          Stop-Transcript | Out-Null
          exit 0

      # ============================
      # BACKEND & FRONTEND BUILD
      # ============================
      - name: Install and build frontend/backend
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $appRoot = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT

          $backend = Join-Path $appRoot "backend"
          $frontend = Join-Path $appRoot "frontend"

          # Backend
          if (Test-Path $backend) {
            cd $backend
            npm install
          }

          # Frontend
          if (Test-Path $frontend) {
            cd $frontend
            npm install
            $env:CI = "false"
            npm run build:prod
          }

          Stop-Transcript | Out-Null
          exit 0

      # ============================
      # PYTHON SERVICE
      # ============================
      - name: Setup python service
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $srv = Join-Path (Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT) "python-service"
          if (-not (Test-Path $srv)) { exit 0 }

          cd $srv

          if (-not (Test-Path ".venv")) {
            & $env:PYTHON_EXE -m venv .venv
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

          Stop-Transcript | Out-Null
          exit 0