name: Build & Deploy VerveStacks

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  DEPLOY_ROOT: "C:\\inetpub\\vervestacks\\vervestacks-dashboard"

  # Correct paths (your project is under vervestacks-dashboard)
  BACKEND_DIR: "vervestacks-dashboard/backend"
  FRONTEND_DIR: "vervestacks-dashboard/frontend"
  PYTHON_DIR: "vervestacks-dashboard/python-service"

  IIS_SITE_NAME: "vervestacks"

  # Your server's Python executable
  PYTHON_EXE: "D:\\Pyvenvs\\Scripts\\python.exe"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # BACKEND (npm install only)
      # ------------------------------
      - name: Install backend dependencies
        shell: powershell
        run: |
          cd $env:BACKEND_DIR
          npm install

      # ------------------------------
      # PYTHON SERVICE (venv + requirements)
      # ------------------------------
      - name: Setup python-service
        shell: powershell
        run: |
          cd $env:PYTHON_DIR

          if (-not (Test-Path ".venv")) {
            Write-Host "Creating venv using $env:PYTHON_EXE"
            & $env:PYTHON_EXE -m venv .venv
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

      # ------------------------------
      # FRONTEND BUILD (CI=false)
      # ------------------------------
      - name: Build frontend (CI=false)
        shell: powershell
        run: |
          cd $env:FRONTEND_DIR
          npm install

          # Disable warnings-as-errors
          $env:CI="false"

          npm run build:prod

      # ------------------------------
      # STOP IIS
      # ------------------------------
      - name: Stop IIS site
        shell: powershell
        run: |
          Import-Module WebAdministration
          Stop-Website -Name $env:IIS_SITE_NAME -ErrorAction SilentlyContinue

      # ------------------------------
      # DEPLOY FRONTEND
      # ------------------------------
      - name: Deploy frontend to IIS
        shell: powershell
        run: |
          Write-Host "=== Checking frontend build path ==="
          Write-Host "FRONTEND_DIR = $env:FRONTEND_DIR"

          $sourceBuild = Join-Path $env:FRONTEND_DIR "build"
          Write-Host "Source build folder should be: $sourceBuild"

          if (-not (Test-Path $sourceBuild)) {
            Write-Error "ERROR: Frontend build folder NOT found at $sourceBuild"
            Write-Error "Check if npm run build:prod actually created a build folder."
            exit 1
          }

          $targetBuild = Join-Path $env:DEPLOY_ROOT "frontend\\build"
          Write-Host "Deploying to: $targetBuild"

          if (-not (Test-Path $targetBuild)) {
            New-Item -ItemType Directory -Path $targetBuild | Out-Null
          }

          robocopy $sourceBuild $targetBuild /MIR /NFL /NDL /NJH /NJS /NP
          $rc = $LASTEXITCODE
          Write-Host "Robocopy exited with code $rc"

          if ($rc -ge 8) {
            Write-Error "Robocopy failed with exit code $rc"
            exit $rc
          }

          # Normalize robocopy success exit codes (0–7) to 0 for GitHub Actions
          exit 0

      # ------------------------------
      # DEPLOY BACKEND + PYTHON
      # ------------------------------
      - name: Deploy backend & python-service
        shell: powershell
        run: |
          $backendTarget = Join-Path $env:DEPLOY_ROOT "backend"
          $pythonTarget  = Join-Path $env:DEPLOY_ROOT "python-service"

          if (-not (Test-Path $backendTarget)) {
            New-Item -ItemType Directory -Path $backendTarget | Out-Null
          }
          if (-not (Test-Path $pythonTarget)) {
            New-Item -ItemType Directory -Path $pythonTarget | Out-Null
          }

          Write-Host "=== Deploying backend ==="
          robocopy $env:BACKEND_DIR $backendTarget /MIR /NFL /NDL /NJH /NJS /NP
          $rcBackend = $LASTEXITCODE
          Write-Host "Backend robocopy exited with code $rcBackend"

          if ($rcBackend -ge 8) {
            Write-Error "Backend robocopy failed with exit code $rcBackend"
            exit $rcBackend
          }

          Write-Host "=== Deploying python-service ==="
          robocopy $env:PYTHON_DIR $pythonTarget /MIR /NFL /NDL /NJH /NJS /NP
          $rcPy = $LASTEXITCODE
          Write-Host "Python-service robocopy exited with code $rcPy"

          if ($rcPy -ge 8) {
            Write-Error "Python-service robocopy failed with exit code $rcPy"
            exit $rcPy
          }

          # Normalize 0–7 as success
          exit 0

      # ------------------------------
      # START IIS
      # ------------------------------
      - name: Start IIS Site
        shell: powershell
        run: |
          Import-Module WebAdministration
          Start-Website -Name $env:IIS_SITE_NAME
