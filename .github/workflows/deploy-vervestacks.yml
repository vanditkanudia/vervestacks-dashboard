name: Build & Deploy VerveStacks (LOCAL)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  # Local IIS deployment path (Option B)
  DEPLOY_ROOT: "C:\\inetpub\\VerveStacks\\vervestacks-dashboard"

  # Project folders inside your repo
  BACKEND_DIR: "vervestacks-dashboard/backend"
  FRONTEND_DIR: "vervestacks-dashboard/frontend"
  PYTHON_DIR: "vervestacks-dashboard/python-service"

  # Local Python interpreter
  PYTHON_EXE: "D:\\Pyvenvs\\Scripts\\python.exe"

jobs:
  build-and-deploy-local:
    runs-on: self-hosted   # your local Windows runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # BACKEND (npm install only)
      # ------------------------------
      - name: Install backend dependencies
        shell: powershell
        run: |
          Write-Host "=== Backend: npm install ==="
          Write-Host "BACKEND_DIR = $env:BACKEND_DIR"
          cd $env:BACKEND_DIR
          npm install

      # ------------------------------
      # PYTHON SERVICE (venv + requirements)
      # ------------------------------
      - name: Setup python-service
        shell: powershell
        run: |
          Write-Host "=== Python service: venv + requirements ==="
          Write-Host "PYTHON_DIR  = $env:PYTHON_DIR"
          Write-Host "PYTHON_EXE  = $env:PYTHON_EXE"

          cd $env:PYTHON_DIR

          if (-not (Test-Path ".venv")) {
            Write-Host "Creating virtual environment using $env:PYTHON_EXE ..."
            & $env:PYTHON_EXE -m venv .venv
          }
          else {
            Write-Host "Virtual environment .venv already exists, reusing it."
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

      # ------------------------------
      # FRONTEND BUILD (CI=false)
      # ------------------------------
      - name: Build frontend (CI=false)
        shell: powershell
        run: |
          Write-Host "=== Frontend: npm install + build:prod ==="
          Write-Host "FRONTEND_DIR = $env:FRONTEND_DIR"

          cd $env:FRONTEND_DIR
          npm install

          # Prevent eslint warnings from failing the build
          $env:CI = "false"

          npm run build:prod

      # ------------------------------
      # DEPLOY FRONTEND TO LOCAL IIS FOLDER
      # ------------------------------
      - name: Deploy frontend to local IIS folder
        shell: powershell
        run: |
          Write-Host "=== Deploying frontend locally ==="
          Write-Host "FRONTEND_DIR = $env:FRONTEND_DIR"
          Write-Host "DEPLOY_ROOT  = $env:DEPLOY_ROOT"

          $sourceBuild = Join-Path $env:FRONTEND_DIR "build"
          Write-Host "Source build folder: $sourceBuild"

          if (-not (Test-Path $sourceBuild)) {
            Write-Error "ERROR: Frontend build folder NOT found at $sourceBuild"
            exit 1
          }

          # For Option B: index.html goes directly under vervestacks-dashboard
          $targetRoot = $env:DEPLOY_ROOT
          if (-not (Test-Path $targetRoot)) {
            Write-Host "DEPLOY_ROOT not found, creating: $targetRoot"
            New-Item -ItemType Directory -Path $targetRoot | Out-Null
          }

          Write-Host "Running robocopy from $sourceBuild to $targetRoot ..."
          robocopy $sourceBuild $targetRoot /MIR /NFL /NDL /NJH /NJS /NP
          $rc = $LASTEXITCODE
          Write-Host "Frontend robocopy exited with code $rc"

          if ($rc -ge 8) {
            Write-Error "Frontend robocopy failed with exit code $rc"
            exit $rc
          }

          # Normalize robocopy success codes 0–7 to 0 for GitHub Actions
          exit 0

      # ------------------------------
      # DEPLOY BACKEND + PYTHON FILES LOCALLY
      # ------------------------------
      - name: Deploy backend & python-service locally
        shell: powershell
        run: |
          Write-Host "=== Deploying backend & python-service locally ==="
          Write-Host "DEPLOY_ROOT  = $env:DEPLOY_ROOT"
          Write-Host "BACKEND_DIR  = $env:BACKEND_DIR"
          Write-Host "PYTHON_DIR   = $env:PYTHON_DIR"

          $backendTarget = Join-Path $env:DEPLOY_ROOT "backend"
          $pythonTarget  = Join-Path $env:DEPLOY_ROOT "python-service"

          if (-not (Test-Path $backendTarget)) {
            Write-Host "Creating backend target folder: $backendTarget"
            New-Item -ItemType Directory -Path $backendTarget | Out-Null
          }
          if (-not (Test-Path $pythonTarget)) {
            Write-Host "Creating python-service target folder: $pythonTarget"
            New-Item -ItemType Directory -Path $pythonTarget | Out-Null
          }

          Write-Host "Copying backend files..."
          robocopy $env:BACKEND_DIR $backendTarget /MIR /NFL /NDL /NJH /NJS /NP
          $rcBackend = $LASTEXITCODE
          Write-Host "Backend robocopy exited with code $rcBackend"

          if ($rcBackend -ge 8) {
            Write-Error "Backend robocopy failed with exit code $rcBackend"
            exit $rcBackend
          }

          Write-Host "Copying python-service files..."
          robocopy $env:PYTHON_DIR $pythonTarget /MIR /NFL /NDL /NJH /NJS /NP
          $rcPy = $LASTEXITCODE
          Write-Host "Python-service robocopy exited with code $rcPy"

          if ($rcPy -ge 8) {
            Write-Error "Python-service robocopy failed with exit code $rcPy"
            exit $rcPy
          }

          # Normalize 0–7 as success
          exit 0
