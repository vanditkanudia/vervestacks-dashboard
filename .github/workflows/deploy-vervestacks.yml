name: Deploy VerveStacks Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  Update_Data_On_Local: "true"
  Update_Data_On_Hetzner: "false"

  DEPLOY_ROOT: "C:\\inetpub\\VerveStacks"
  DATA_ROOT: "C:\\inetpub\\VerveStacks\\data"

  LOCAL_DATA_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\data"
  KANVAULT_SHARE: "\\\\192.168.0.7\\kanvault"

  DEST_OSM: "C:\\inetpub\\VerveStacks\\data\\OSM-kan-prebuilt"
  DEST_TRANSMISSION: "C:\\inetpub\\VerveStacks\\data\\transmission_line_generation"
  DEST_ATLITE: "C:\\inetpub\\VerveStacks\\data\\Atlite_data_optimized"
  DEST_REZONING: "C:\\inetpub\\VerveStacks\\data\\REZoning_world_data"

  APP_SUBROOT: "vervestacks-dashboard"

  PYTHON_EXE: "C:\\Python312\\python.exe"
  APP_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\vervestacks-dashboard"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # LOGGER INIT
      - name: Init log
        shell: powershell
        run: |
          $folder = "D:\GitHub\VerveStacks_Logs"
          if (-not (Test-Path $folder)) { New-Item -ItemType Directory -Path $folder | Out-Null }

          $ts = Get-Date -Format "yyyy-MM-ddTHH-mm-ss"
          $log = "$folder\deploy_vervestacks_$ts.log"
          "LOG_FILE=$log" | Out-File -FilePath $env:GITHUB_ENV -Encoding UTF8 -Append
          exit 0

      # ================
      # MAP KANVAULT SHARE
      # ================
      - name: Map kanvault share
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        env:
          KANVAULT_PASSWORD: ${{ secrets.KANVAULT_PASSWORD }}
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null

          $ErrorActionPreference = "Stop"
          trap {
            Write-Host "MAP FAILED: $($_.Exception.Message)"
            Stop-Transcript | Out-Null
            exit 1
          }

          Write-Host "Mapping: $env:KANVAULT_SHARE"

          net use $env:KANVAULT_SHARE /delete /y 2>$null
          net use $env:KANVAULT_SHARE /user:amit $env:KANVAULT_PASSWORD
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to map share"
              Stop-Transcript | Out-Null
              exit 1
          }

          Stop-Transcript | Out-Null
          exit 0

      # =================================
      # SYNC DATA
      # =================================
      - name: Sync all data to IIS
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $shareRoot = $env:KANVAULT_SHARE
          $verveRoot = Join-Path $shareRoot "KanORS_Data\VerveStacks"
          $rezRoot   = Join-Path $shareRoot "KanORS_Data\REZoning data"

          $jobs = @(
            @{Name="OSM-kan-prebuilt"; Source=Join-Path $verveRoot "OSM-kan-prebuilt"; Dest=$env:DEST_OSM},
            @{Name="OSM-kan-prebuilt (harish)"; Source=Join-Path $verveRoot "OSM-kan-prebuilt\harish"; Dest=$env:DEST_OSM},
            @{Name="transmission_line_generation"; Source=Join-Path $verveRoot "transmission_line_generation"; Dest=$env:DEST_TRANSMISSION},
            @{Name="Atlite_data_optimized"; Source=Join-Path $rezRoot "Atlite_data\Atlite_data_optimized"; Dest=$env:DEST_ATLITE},
            @{Name="REZoning_world_data"; Source=Join-Path $rezRoot "REZoning_world_data"; Dest=$env:DEST_REZONING}
          )

          foreach ($j in $jobs) {
            Write-Host "--- Sync: $($j.Name)"
            if (-not (Test-Path $j.Source)) {
              Write-Host "Skip: Source missing"
              continue
            }
            if (-not (Test-Path $j.Dest)) { New-Item -ItemType Directory -Path $j.Dest | Out-Null }

            robocopy $j.Source $j.Dest /E /Z /R:3 /W:5 /NP
            if ($LASTEXITCODE -ge 8) {
              Write-Host "Robocopy Failed!"
              Stop-Transcript | Out-Null
              exit $LASTEXITCODE
            }
          }

          Stop-Transcript | Out-Null
          exit 0

      # ============================================
      # DEPLOY APP (COPY EXACT FOLDER STRUCTURE)
      # ============================================
      - name: Deploy app folder structure
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $src = $env:APP_SOURCE_ROOT
          $dst = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT

          Write-Host "Copy from $src to $dst"

          if (-not (Test-Path $dst)) { New-Item -ItemType Directory -Path $dst | Out-Null }

          # EXACT STRUCTURE COPY
          # /XD excludes only .git and .github folders, but keeps files like .gitignore, .gitattributes, etc.
          robocopy $src $dst /E /Z /R:3 /W:5 /XD ".git" ".github" /NP
          if ($LASTEXITCODE -ge 8) {
              Write-Host "App copy failed!"
              Stop-Transcript | Out-Null
              exit $LASTEXITCODE
          }

          Stop-Transcript | Out-Null
          exit 0

      # =============================================
      # NPM INSTALL + REACT BUILD INSIDE FRONTEND ONLY
      # =============================================
      - name: Install frontend + backend deps & build React
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null

          $ErrorActionPreference = "Stop"

          $appRoot = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $backend = Join-Path $appRoot "backend"
          $frontend = Join-Path $appRoot "frontend"

          # Backend NPM install
          if (Test-Path $backend) {
            cd $backend
            npm install
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Backend npm install failed"
              Stop-Transcript | Out-Null
              exit 1
            }
          }

          # Frontend NPM install + build
          if (Test-Path $frontend) {
            cd $frontend
            npm install
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Frontend npm install failed"
              Stop-Transcript | Out-Null
              exit 1
            }

            $env:CI = "false"
            npm run build:prod
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Frontend build failed"
              Stop-Transcript | Out-Null
              exit 1
            }
          }

          Stop-Transcript | Out-Null
          exit 0

      # =============================
      # PYTHON SERVICE ENV SETUP
      # =============================
      - name: Setup python service
        shell: powershell
        run: |
          $log = $env:LOG_FILE
          Start-Transcript -Path $log -Append | Out-Null
          $ErrorActionPreference = "Stop"

          $pythonPath = Join-Path (Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT) "python-service"

          if (-not (Test-Path $pythonPath)) {
            Write-Host "Python service not found!"
            Stop-Transcript | Out-Null
            exit 1
          }

          cd $pythonPath

          if (-not (Test-Path ".venv")) {
            & $env:PYTHON_EXE -m venv .venv
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

          Stop-Transcript | Out-Null
          exit 0