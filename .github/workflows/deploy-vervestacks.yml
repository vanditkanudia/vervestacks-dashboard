name: Deploy VerveStacks Dashboard

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  # Flags
  Update_Data_On_Local: "true"
  Update_Data_On_Hetzner: "false"

  # Deployment roots
  DEPLOY_ROOT: "C:\\inetpub\\VerveStacks"
  DATA_ROOT: "C:\\inetpub\\VerveStacks\\data"

  # Local data source root (your main local data source)
  LOCAL_DATA_SOURCE_ROOT: "D:\\GitHub\\VerveStacks\\data"

  # Base UNC share
  KANVAULT_SHARE: "\\\\192.168.0.7\\kanvault"

  # Destination data paths
  DEST_OSM: "C:\\inetpub\\VerveStacks\\data\\OSM-kan-prebuilt"
  DEST_TRANSMISSION: "C:\\inetpub\\VerveStacks\\data\\transmission_line_generation"
  DEST_ATLITE: "C:\\inetpub\\VerveStacks\\data\\hourly_profiles\\Atlite_data"
  DEST_REZONING: "C:\\inetpub\\VerveStacks\\data\\REZoning"

  # App root (under DEPLOY_ROOT)
  APP_SUBROOT: "vervestacks-dashboard"

  # Python executable on the runner
  PYTHON_EXE: "D:\\Pyvenvs\\Scripts\\python.exe"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # =====================
      # CHECKOUT REPOSITORY
      # =====================
      - name: Checkout code
        uses: actions/checkout@v4

      # =====================
      # MAP UNC SHARE (kanvault)
      # =====================
      - name: Map kanvault share
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        env:
          KANVAULT_PASSWORD: ${{ secrets.KANVAULT_PASSWORD }}
        run: |
          Write-Host "=== Mapping $env:KANVAULT_SHARE with user 'amit' ==="

          try {
            net use $env:KANVAULT_SHARE /delete /y 2>$null | Out-Null
          }
          catch {
            Write-Host "No existing mapping to delete (or delete failed). Ignoring and continuing."
          }

          $global:LASTEXITCODE = 0
          net use $env:KANVAULT_SHARE /user:amit $env:KANVAULT_PASSWORD
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Error "Failed to map $env:KANVAULT_SHARE. Exit code: $exitCode"
            exit $exitCode
          }

          Write-Host "UNC network share mapped successfully."

      # ==========================================================
      # 1) ALL DATA SYNC (KANVAULT + LOCAL) IN ONE STEP
      # ==========================================================
      - name: Sync all data (kanvault + local) to IIS
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          Write-Host "=== [PART 1] Syncing data from kanvault to C:\inetpub\VerveStacks\data ==="

          # ---------- KANVAULT SYNC ----------
          $shareRoot = $env:KANVAULT_SHARE
          $verveRoot = Join-Path $shareRoot "KanORS_Data\VerveStacks"
          $rezRoot   = Join-Path $shareRoot "KanORS_Data\REZoning data"

          Write-Host "VerveStacks UNC root = $verveRoot"
          Write-Host "REZoning UNC root    = $rezRoot"

          $syncJobs = @(
            @{
              Name   = "OSM-kan-prebuilt (harish)"
              Source = Join-Path $verveRoot "OSM-kan-prebuilt\harish"
              Dest   = $env:DEST_OSM
            },
            @{
              Name   = "transmission_line_generation"
              Source = Join-Path $verveRoot "transmission_line_generation"
              Dest   = $env:DEST_TRANSMISSION
            },
            @{
              Name   = "Atlite_data_optimized"
              Source = Join-Path $rezRoot "Atlite_data\Atlite_data_optimized"
              Dest   = $env:DEST_ATLITE
            },
            @{
              Name   = "REZoning_world_data"
              Source = Join-Path $rezRoot "REZoning_world_data"
              Dest   = $env:DEST_REZONING
            }
          )

          $exitCodes = @()

          foreach ($job in $syncJobs) {
            $name   = $job.Name
            $source = $job.Source
            $dest   = $job.Dest

            Write-Host "----"
            Write-Host "Job: $name"
            Write-Host "  Source: $source"
            Write-Host "  Dest  : $dest"

            if (-not [string]::IsNullOrWhiteSpace($dest)) {
              if (-not (Test-Path $dest)) {
                Write-Host "Creating local data folder (with parents if needed): $dest"
                [System.IO.Directory]::CreateDirectory($dest) | Out-Null
              }
            }

            if (-not (Test-Path $source)) {
              Write-Warning "Source path does not exist for job '$name': $source. Skipping this job."
              $exitCodes += 0
              continue
            }

            Write-Host "Syncing $name ..."
            robocopy $source $dest /E /XD ".git" ".github" /NFL /NDL /NJH /NJS /NP
            $rc = $LASTEXITCODE
            Write-Host "Robocopy exit code for '$name': $rc"
            $exitCodes += $rc
          }

          $maxCode = if ($exitCodes.Count -gt 0) {
            ($exitCodes | Measure-Object -Maximum).Maximum
          } else {
            0
          }

          if ($maxCode -ge 8) {
            Write-Error "At least one kanvault data sync robocopy failed. Highest exit code: $maxCode"
            exit $maxCode
          }

          Write-Host "UNC (kanvault) data sync completed successfully with maximum robocopy code: $maxCode"

          # ---------- LOCAL DATA SYNC ----------
          Write-Host ""
          Write-Host "=== [PART 2] Syncing LOCAL data from D:\GitHub\VerveStacks\data → C:\inetpub\VerveStacks\data ==="

          $srcLocal = $env:LOCAL_DATA_SOURCE_ROOT
          $dstLocal = $env:DATA_ROOT

          Write-Host "Local data source     : $srcLocal"
          Write-Host "IIS data destination  : $dstLocal"

          if (-not (Test-Path $srcLocal)) {
            Write-Host "WARNING: Local data source folder does not exist: $srcLocal"
            Write-Host "Nothing to sync from local; continuing."
          }
          else {
            if (-not (Test-Path $dstLocal)) {
              Write-Host "Creating IIS data root: $dstLocal"
              [System.IO.Directory]::CreateDirectory($dstLocal) | Out-Null
            }

            robocopy $srcLocal $dstLocal /E /Z /R:3 /W:5 /XD ".git" ".github" /NFL /NDL /NJH /NJS /NP
            $codeLocal = $LASTEXITCODE
            Write-Host "Local data robocopy exit code: $codeLocal"

            if ($codeLocal -ge 8) {
              Write-Error "Local data sync failed with robocopy exit code $codeLocal"
              exit $codeLocal
            }

            Write-Host "Local data sync completed successfully."
          }

          Write-Host "=== All data sync (kanvault + local) finished successfully. ==="
          exit 0

      # ==========================================================
      # 2) DEPLOY ENTIRE REPO → C:\inetpub\VerveStacks
      # ==========================================================
      - name: Deploy entire VerveStacks to IIS (overwrite only, no git folders)
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          Write-Host "=== Deploying entire VerveStacks repo to LOCAL IIS ==="

          $src = "$env:GITHUB_WORKSPACE"
          $dst = $env:DEPLOY_ROOT

          Write-Host "Source folder     : $src"
          Write-Host "Destination folder: $dst"

          if (-not (Test-Path $src)) {
            Write-Error "Source folder does not exist: $src"
            exit 1
          }

          if (-not (Test-Path $dst)) {
            Write-Host "Creating IIS deployment folder: $dst"
            New-Item -ItemType Directory -Path $dst -Force | Out-Null
          }

          robocopy $src $dst /E /Z /R:3 /W:5 /XD ".git" ".github" /NFL /NDL /NJH /NJS /NP
          $code = $LASTEXITCODE
          Write-Host "App robocopy exit code: $code"

          if ($code -ge 8) {
            Write-Error "Deployment failed with robocopy exit code $code"
            exit $code
          }

          Write-Host "Deployment completed successfully."
          exit 0

      # =========================================
      # 3) BACKEND + FRONTEND (npm) ON DESTINATION
      # =========================================
      - name: Install JS deps and build frontend on DEPLOY_ROOT
        shell: powershell
        run: |
          Write-Host "=== JS apps: backend install + frontend install+build on DEPLOY_ROOT ==="

          $appRoot   = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $backend   = Join-Path $appRoot "backend"
          $frontend  = Join-Path $appRoot "frontend"

          $apps = @(
            @{ Name = "Backend"; Path = $backend; Build = $false },
            @{ Name = "Frontend"; Path = $frontend; Build = $true }
          )

          foreach ($app in $apps) {
            $name  = $app.Name
            $path  = $app.Path
            $build = $app.Build

            Write-Host "----"
            Write-Host "$name: Path = $path"

            if (-not (Test-Path $path)) {
              Write-Error "$name path does not exist: $path"
              exit 1
            }

            cd $path
            Write-Host "$name: running npm install..."
            npm install

            if ($build) {
              Write-Host "$name: running build:prod with CI=false..."
              $env:CI = "false"
              npm run build:prod
            }
          }

      # =========================================
      # 4) PYTHON SERVICE (venv + requirements) ON DEST
      # =========================================
      - name: Setup python service on deployed folder
        shell: powershell
        run: |
          Write-Host "=== Python-service: venv + requirements (on DEPLOY_ROOT) ==="

          $appRoot    = Join-Path $env:DEPLOY_ROOT $env:APP_SUBROOT
          $pythonPath = Join-Path $appRoot "python-service"

          Write-Host "Python service path = $pythonPath"
          Write-Host "PYTHON_EXE         = $env:PYTHON_EXE"

          if (-not (Test-Path $pythonPath)) {
            Write-Error "Python service path does not exist: $pythonPath"
            exit 1
          }

          cd $pythonPath

          if (-not (Test-Path ".venv")) {
            Write-Host "Creating virtual environment using $env:PYTHON_EXE ..."
            & $env:PYTHON_EXE -m venv .venv
          }
          else {
            Write-Host "Virtual environment .venv already exists, reusing it."
          }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          .\.venv\Scripts\python.exe -m pip install -r requirements.txt

      # =========================================
      # 5) PLACEHOLDER: HETZNER DEPLOY (FUTURE)
      # =========================================
      - name: Deploy to Hetzner (placeholder)
        if: env.Update_Data_On_Hetzner == 'true'
        shell: powershell
        run: |
          Write-Host "=== Update_Data_On_Hetzner == true ==="
          Write-Host "Hetzner deployment not implemented yet."

      # =========================================
      # 6) RUN start.bat AT THE END (FROM DEPLOY_ROOT)
      # =========================================
      - name: Run start.bat after deployment
        if: env.Update_Data_On_Local == 'true'
        shell: powershell
        run: |
          Write-Host "=== Running start.bat AFTER deployment (from DEPLOY_ROOT) ==="

          $scriptPath = Join-Path $env:DEPLOY_ROOT "$env:APP_SUBROOT\start.bat"
          Write-Host "Expected start.bat path: $scriptPath"

          if (-not (Test-Path $scriptPath)) {
            Write-Error "start.bat not found at $scriptPath"
            exit 1
          }

          & $scriptPath
          $rc = $LASTEXITCODE

          if ($rc -ne 0) {
            Write-Error "start.bat failed with exit code $rc."
            exit $rc
          }

          Write-Host "start.bat completed successfully."